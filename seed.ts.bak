import { PrismaClient } from "./app/generated/prisma/client";
import { PrismaPg } from "@prisma/adapter-pg";
import "dotenv/config";
import { auth } from "./lib/auth";

const adapter = new PrismaPg({
  connectionString: process.env.DATABASE_URL,
});

const prisma = new PrismaClient({
  adapter,
});

const DEV_ADMIN_EMAIL = "admin@admin.com";
const DEV_ADMIN_PASSWORD = "password";
const DEV_ADMIN_NAME = "Admin";
const DEV_STUDENT_EMAIL = "user@user.com";
const DEV_STUDENT_PASSWORD = "password";
const DEV_STUDENT_NAME = "User";

async function seedSampleQuestions() {
  const subject = await prisma.subject.upsert({
    where: { code: "ACtE" },
    create: { code: "ACtE", name: "Computer Engineering" },
    update: { name: "Computer Engineering" },
    select: { id: true },
  });

  // ---------- UNIT: AExE01 ----------
  const unitAExE01 = await prisma.unit.upsert({
    where: {
      subjectId_code: { subjectId: subject.id, code: "AExE01" },
    },
    create: {
      subjectId: subject.id,
      code: "AExE01",
      name: "Concept of Basic Electrical and Electronics Engineering",
    },
    update: {
      name: "Concept of Basic Electrical and Electronics Engineering",
    },
    select: { id: true },
  });

  await prisma.question.upsert({
    where: { externalId: "AExE01-0001" },
    create: {
      unitId: unitAExE01.id,
      externalId: "AExE01-0001",
      prompt: "Ohm’s law relates which quantities?",
      choices: [
        "Voltage, current, and resistance",
        "Power and energy only",
        "Charge and flux",
        "Capacitance and inductance",
      ],
      correctIndex: 0,
      explanation: "Ohm’s law is V = I·R.",
      difficulty: "easy",
      tags: ["ohms-law", "basics"],
      references: ["NEC syllabus AExE01"],
      isActive: true,
    },
    update: {},
  });

  const genAExE01 = Array.from({ length: 99 }, (_, i) => {
    const seq = i + 2;
    return {
      unitId: unitAExE01.id,
      externalId: `AExE01-${String(seq).padStart(4, "0")}`,
      prompt: `Sample (AExE01) Question ${seq}: If V=10V and R=5Ω, current I equals?`,
      choices: ["2 A", "0.5 A", "5 A", "50 A"],
      correctIndex: 0,
      explanation: "I = V / R = 2 A",
      difficulty: seq % 3 === 0 ? "medium" : "easy",
      tags: ["seed", "aexe01"],
      references: ["DEV seed data"],
      isActive: true,
    };
  });

  await prisma.question.createMany({
    data: genAExE01,
    skipDuplicates: true,
  });

  // ---------- UNIT: AExE02 ----------
  const unitAExE02 = await prisma.unit.upsert({
    where: {
      subjectId_code: { subjectId: subject.id, code: "AExE02" },
    },
    create: {
      subjectId: subject.id,
      code: "AExE02",
      name: "Digital Logic and Microprocessor",
    },
    update: {
      name: "Digital Logic and Microprocessor",
    },
    select: { id: true },
  });

  await prisma.question.upsert({
    where: { externalId: "AExE02-0001" },
    create: {
      unitId: unitAExE02.id,
      externalId: "AExE02-0001",
      prompt: "Binary number 1011 is equivalent to decimal:",
      choices: ["11", "10", "12", "13"],
      correctIndex: 0,
      explanation: "1011₂ = 11₁₀",
      difficulty: "easy",
      tags: ["binary", "number-system"],
      references: ["NEC syllabus AExE02"],
      isActive: true,
    },
    update: {},
  });

  const genAExE02 = Array.from({ length: 99 }, (_, i) => {
    const seq = i + 2;
    const n = seq + 5;
    return {
      unitId: unitAExE02.id,
      externalId: `AExE02-${String(seq).padStart(4, "0")}`,
      prompt: `Sample (AExE02) Question ${seq}: Decimal ${n} in binary is?`,
      choices: [
        n.toString(2),
        (n + 1).toString(2),
        (n - 1).toString(2),
        (n + 2).toString(2),
      ],
      correctIndex: 0,
      explanation: `Convert ${n}₁₀ to binary`,
      difficulty: seq % 4 === 0 ? "medium" : "easy",
      tags: ["seed", "aexe02"],
      references: ["DEV seed data"],
      isActive: true,
    };
  });

  await prisma.question.createMany({
    data: genAExE02,
    skipDuplicates: true,
  });
}

async function seedUsers() {
  if (process.env.NODE_ENV === "production") return;

  const admin = await prisma.user.findUnique({
    where: { email: DEV_ADMIN_EMAIL },
  });

  const adminId =
    admin?.id ??
    (
      await auth.api.signUpEmail({
        body: {
          name: DEV_ADMIN_NAME,
          email: DEV_ADMIN_EMAIL,
          password: DEV_ADMIN_PASSWORD,
        },
      })
    ).user.id;

  await prisma.userProfile.upsert({
    where: { userId: adminId },
    create: { userId: adminId, role: "admin" },
    update: {},
  });

  const student = await prisma.user.findUnique({
    where: { email: DEV_STUDENT_EMAIL },
  });

  const studentId =
    student?.id ??
    (
      await auth.api.signUpEmail({
        body: {
          name: DEV_STUDENT_NAME,
          email: DEV_STUDENT_EMAIL,
          password: DEV_STUDENT_PASSWORD,
        },
      })
    ).user.id;

  await prisma.userProfile.upsert({
    where: { userId: studentId },
    create: { userId: studentId, role: "student" },
    update: {},
  });
}

async function main() {
  await seedUsers();
  await seedSampleQuestions();
}

main()
  .then(() => prisma.$disconnect())
  .catch(async (e) => {
    console.error(e);
    await prisma.$disconnect();
    process.exit(1);
  });
